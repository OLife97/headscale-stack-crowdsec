services:
  headscale:
    image: docker.io/headscale/headscale:${HEADSCALE_VERSION:-latest}
    container_name: headscale
    hostname: headscale
    restart: unless-stopped
    command: serve
    ports:
      - "0.0.0.0:3478:3478/udp" # STUN/DERP
    volumes:
      - ./headscale/config/config.yaml:/etc/headscale/config.yaml:ro
      - ./headscale/data:/var/lib/headscale
    env_file: .env
    environment:
      - HEADSCALE_SERVER_URL=https://${SUBDOMAIN}.${DOMAIN}
      - HEADSCALE_LISTEN_ADDR=0.0.0.0:8080
      - HEADSCALE_METRICS_LISTEN_ADDR=0.0.0.0:9090
      - HEADSCALE_GRPC_LISTEN_ADDR=0.0.0.0:50443
    networks:
      - proxy
    depends_on:
      caddy:
        condition: service_started
    healthcheck:
      test: ["CMD", "headscale", "health"]
      interval: 10s
      timeout: 5s
      retries: 3

  caddy:
    image: ghcr.io/olife97/dhi-caddy-cloudflare:${CADDY_VERSION:-latest}
    container_name: caddy
    restart: unless-stopped
    ports:
      - "80:8080"
      - "443:8443"
      - "443:8443/udp" # HTTP/3 (QUIC)
    volumes:
      - ./caddy/Caddyfile:/etc/caddy/Caddyfile:ro
      - caddy_data:/data
      - caddy_config:/config
      - caddy_logs:/var/log/caddy
      - ./caddy/data/GeoLite2-Country.mmdb:/data/GeoLite2-Country.mmdb:ro
    environment:
      - DOMAIN=${DOMAIN}
      - SUBDOMAIN=${SUBDOMAIN}
      - FULLDOMAIN=${SUBDOMAIN}.${DOMAIN}
      - CF_API_TOKEN=${CF_API_TOKEN}
      - CROWDSEC_BOUNCER_KEY=${CROWDSEC_BOUNCER_KEY}
      - ALLOWED_COUNTRIES=${ALLOWED_COUNTRIES}
    networks:
      - proxy
    depends_on:
      crowdsec:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "caddy", "validate", "--config", "/etc/caddy/Caddyfile"]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 60s

  # --- CROWDSEC (Motore di sicurezza) ---
  crowdsec:
    image: crowdsecurity/crowdsec:${CROWDSEC_VERSION:-latest}
    container_name: crowdsec
    restart: unless-stopped
    volumes:
      - ./crowdsec/data:/var/lib/crowdsec/data
      - ./crowdsec/acquis.yaml:/etc/crowdsec/acquis.yaml:ro
      - caddy_logs:/var/log/caddy:ro
      - ./crowdsec/config/profiles.yaml:/etc/crowdsec/profiles.yaml:ro
      - ./crowdsec/config/notifications/http.yaml:/etc/crowdsec/notifications/http.yaml:ro
    environment:
      - COLLECTIONS=crowdsecurity/caddy crowdsecurity/base-http-scenarios crowdsecurity/linux
      - BOUNCER_KEY_CADDY=${CROWDSEC_BOUNCER_KEY}
      - CROWDSEC_NOTIFY_URL=${CROWDSEC_NOTIFY_URL:-}
      - CROWDSEC_NOTIFY_AUTH_HEADER=${CROWDSEC_NOTIFY_AUTH_HEADER:-}
      - CROWDSEC_NOTIFY_AUTH_TOKEN=${CROWDSEC_NOTIFY_AUTH_TOKEN:-}
    networks:
      - proxy
    healthcheck:
      test: ["CMD", "cscli", "version"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s

networks:
  proxy:
    driver: bridge
volumes:
  caddy_data:
  caddy_config:
  caddy_logs:
