{
    order crowdsec first
    http_port 8080
    https_port 8443

    # Dynamic DNS (global app directive)
    dynamic_dns {
        provider cloudflare {env.CF_API_TOKEN}
        domains {
            {env.DOMAIN} {env.SUBDOMAIN}
        }
        check_interval 5m
        ttl 1h
        ip_source simple_http https://icanhazip.com
        ip_source simple_http https://api64.ipify.org
    }

    # CrowdSec API connection (global app directive)
    crowdsec {
        api_url http://crowdsec:8080
        api_key {env.CROWDSEC_BOUNCER_KEY}
        ticker_interval 15s
    }
}

# VHOST: HEADSCALE
{env.FULLDOMAIN} {
    # CrowdSec middleware (controlla ogni richiesta)
    crowdsec

    log {
        output file /var/log/caddy/access.log
        format json
    }

    # GeoIP MaxMind Filter
    @geofilter {
        maxmind_geolocation {
            db_path /data/GeoLite2-Country.mmdb
            allow_countries {env.ALLOWED_COUNTRIES}
        }
    }

    handle @geofilter {
        reverse_proxy headscale:8080
    }

    handle {
        respond "Access denied: not allowed" 403
    }
}
