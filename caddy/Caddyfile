{
    order crowdsec first
    http_port 8080
    https_port 8443

    # Dynamic DNS
    dynamic_dns {
        provider cloudflare {$CF_API_TOKEN}
        domains {
            {$DOMAIN} {$SUBDOMAIN}
        }
        check_interval 5m
        ttl 1h
        ip_source simple_http https://icanhazip.com
        ip_source simple_http https://api64.ipify.org
    }

    # CrowdSec Global
    crowdsec {
        api_url http://crowdsec:8080
        api_key {$CROWDSEC_BOUNCER_KEY}
        ticker_interval 15s
    }
}

# VHOST: HEADSCALE
{$FULLDOMAIN} {
    crowdsec

    log {
        output file /var/log/caddy/access.log
        format json
    }

    @geofilter {
        maxmind_geolocation {
            db_path /data/GeoLite2-Country.mmdb
            allow_countries {$ALLOWED_COUNTRIES}
        }
    }

    handle @geofilter {
        reverse_proxy headscale:8080
    }

    handle {
        respond "Access denied: not allowed" 403
    }
}
